AWSTemplateFormatVersion: 2010-09-09
Description: Test VPC Deployment
Parameters:
  ProjectName:
    Description: A descriptive label used in Name tags
    Type: String
    Default: ''
  TestVpcCidrBlock:
    Description: Class B VPC Network CIDR, First two octets
    Type: String
    Default: '10.100'
  ManagementVpcCidrBlock:
    Description: Class B VPC Network CIDR, First two octets
    Type: String
    Default: '10.10'
  AvailabilityZone1:
    Description: Availability Zone 1 Name in Region
    Type: AWS::EC2::AvailabilityZone::Name
  AvailabilityZone2:
    Description: Availability Zone 2 Name in Region
    Type: AWS::EC2::AvailabilityZone::Name
  StackTemplates:
    Description: Template service base URL
    Type: String
    Default: https://s3.us-east-2.amazonaws.com/cfn-stacks.com/templates
  InfraTemplates:
    Description: Key name prefix for infrastructure templates
    Type: String
    Default: snapshot/com/cfnstacks/cfn-base-vpc/0.0.1-SNAPSHOT
  BastionAllowedIPs:
    Description: Network CIDR of addresses that are allowed to connect to the bastion
    Type: String
  pEC2KeyPairBastion:
    Description: The SSH key pair in your account to use for the bastion host login
    Type: AWS::EC2::KeyPair::KeyName
  pEC2KeyPair:
    Description: The SSH key pair in your account to use for all other EC2 instance logins
    Type: AWS::EC2::KeyPair::KeyName
Resources:
  TestVpc:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub '${StackTemplates}/${InfraTemplates}/vpc-environment.yaml'
      TimeoutInMinutes: 20
      Parameters:
        pVPCName: !Sub "${ProjectName} Test VPC"
        pRegionAZ1Name: !Ref AvailabilityZone1
        pRegionAZ2Name: !Ref AvailabilityZone2
        pManagementCIDR: !Sub "${ManagementVpcCidrBlock}.0.0/16"
        pCIDR: !Sub "${TestVpcCidrBlock}.0.0/16"
        pAppPrivateSubnetACIDR: !Sub "${TestVpcCidrBlock}.0.0/20"
        pAppPrivateSubnetBCIDR: !Sub "${TestVpcCidrBlock}.16.0/20"
        pDBPrivateSubnetACIDR: !Sub "${TestVpcCidrBlock}.32.0/24"
        pDBPrivateSubnetBCIDR: !Sub "${TestVpcCidrBlock}.33.0/24"
        pDMZSubnetACIDR: !Sub "${TestVpcCidrBlock}.34.0/24"
        pDMZSubnetBCIDR: !Sub "${TestVpcCidrBlock}.35.0/24"
        pTemplates: !Sub "${StackTemplates}/${InfraTemplates}"
  ManagementVpc:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub '${StackTemplates}/${InfraTemplates}/vpc-management.yaml'
      TimeoutInMinutes: 20
      Parameters:
        pBastionSSHCIDR: !Ref BastionAllowedIPs
        pManagementCIDR: !Sub "${ManagementVpcCidrBlock}.0.0/16"
        pManagementPrivateSubnetACIDR: !Sub "${ManagementVpcCidrBlock}.0.0/20"
        pManagementPrivateSubnetBCIDR: !Sub "${ManagementVpcCidrBlock}.16.0/20"
        pManagementDMZSubnetACIDR: !Sub "${ManagementVpcCidrBlock}.34.0/24"
        pManagementDMZSubnetBCIDR: !Sub "${ManagementVpcCidrBlock}.35.0/24"
        pManagementVPCName: !Sub "${ProjectName} Management VPC"
        pTestVPC: !GetAtt TestVpc.Outputs.rVPC
        pTestCIDR: !Sub "${TestVpcCidrBlock}.0.0/16"
        pRouteTableTestPrivateA: !GetAtt TestVpc.Outputs.rRouteTablePrivateA
        pRouteTableTestPrivateB: !GetAtt TestVpc.Outputs.rRouteTablePrivateB
        pRouteTableTestDMZ: !GetAtt TestVpc.Outputs.rRouteTableDMZ
        pEC2KeyPairBastion: !Ref pEC2KeyPairBastion
        pEC2KeyPair: !Ref pEC2KeyPair
        pBastionAmi: !FindInMap [ AWSAMIRegionMap, !Ref 'AWS::Region', AMZNLINUXHVM ]
        pRegionAZ1Name: !Ref AvailabilityZone1
        pRegionAZ2Name: !Ref AvailabilityZone2
        pBastionInstanceType: t2.small
        pSupportsNatGateway: !FindInMap [ RegionServiceSupport, !Ref 'AWS::Region', NatGateway ]
        pNatAmi: !FindInMap [ AWSAMIRegionMap, !Ref 'AWS::Region', AMZNLINUXHVM ]
        pNatInstanceType: !FindInMap [ AWSAMIRegionMap, !Ref 'AWS::Region', InstanceType ]
Mappings:
  RegionServiceSupport:
    us-east-1:
      ConfigRules: true
      NatGateway: true
      Glacier: true
    us-east-2:
      ConfigRules: true
      NatGateway: true
      Glacier: true
    us-west-1:
      ConfigRules: true
      NatGateway: true
      Glacier: true
    us-west-2:
      ConfigRules: true
      NatGateway: true
      Glacier: true
    ca-central-1:
      ConfigRules: false
      NatGateway: true
      Glacier: true
    eu-central-1:
      NatGateway: true
      ConfigRules: true
      Glacier: true
    eu-west-1:
      ConfigRules: true
      NatGateway: true
      Glacier: true
    eu-west-2:
      ConfigRules: false
      NatGateway: true
      Glacier: true
    ap-northeast-1:
      ConfigRules: true
      NatGateway: true
      Glacier: true
    ap-northeast-2:
      ConfigRules: true
      NatGateway: true
      Glacier: true
    ap-south-1:
      ConfigRules: false
      NatGateway: true
      Glacier: true
    ap-southeast-1:
      ConfigRules: true
      NatGateway: true
      Glacier: false
    ap-southeast-2:
      ConfigRules: true
      NatGateway: true
      Glacier: true
    sa-east-1:
      ConfigRules: false
      NatGateway: true
      Glacier: false
    us-gov-west-1:
      ConfigRules: false
      NatGateway: false
      Glacier: false
  AWSInfoRegionMap:
    ap-northeast-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    ap-northeast-2:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    ap-south-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    ap-southeast-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    ap-southeast-2:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    ca-central-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    eu-central-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    eu-west-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    eu-west-2:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    sa-east-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    us-east-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    us-east-2:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    us-gov-west-1:
      Partition: aws-us-gov
      QuickStartS3URL: https://s3-us-gov-west-1.amazonaws.com
    us-west-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    us-west-2:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
  CustomVariables:
    vResourceEnvironmentTagKey:
      Value: Environment
    vResourceEnvironmentTagValue:
      Value: development
  AWSAMIRegionMap:
    AMI:
      AMZNLINUXHVM: amzn-ami-hvm-2017.03.1.20170623-x86_64-gp2
    ap-northeast-1:
      AMZNLINUXHVM: ami-3bd3c45c
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    ap-northeast-2:
      AMZNLINUXHVM: ami-e21cc38c
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    ap-south-1:
      AMZNLINUXHVM: ami-47205e28
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    ap-southeast-1:
      AMZNLINUXHVM: ami-77af2014
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    ap-southeast-2:
      AMZNLINUXHVM: ami-10918173
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    ca-central-1:
      AMZNLINUXHVM: ami-a7aa15c3
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    eu-central-1:
      AMZNLINUXHVM: ami-82be18ed
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    eu-west-1:
      AMZNLINUXHVM: ami-d7b9a2b1
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    eu-west-2:
      AMZNLINUXHVM: ami-ed100689
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    sa-east-1:
      AMZNLINUXHVM: ami-87dab1eb
      InstanceType: m4.large
      InstanceTypeDatabase: db.m3.large
    us-east-1:
      AMZNLINUXHVM: ami-a4c7edb2
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    us-east-2:
      AMZNLINUXHVM: ami-8a7859ef
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    us-gov-west-1:
      AMZNLINUXHVM: ami-ffa61d9e
      InstanceType: m4.large
      InstanceTypeDatabase: db.m3.large
    us-west-1:
      AMZNLINUXHVM: ami-327f5352
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large
    us-west-2:
      AMZNLINUXHVM: ami-6df1e514
      InstanceType: m4.large
      InstanceTypeDatabase: db.m4.large